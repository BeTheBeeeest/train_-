# 火车票候补系统 - 设计文档

## 一、系统概述

本系统实现了火车票候补购票功能，采用C/S架构，支持多客户端并发操作。当车票售罄时，用户可以加入候补队列，系统会在有退票时自动按照排队顺序为候补乘客购票。

## 二、类模型设计

### 2.1 核心类图

```
┌─────────────────────────────────────────────────────────────┐
│                      TicketSystem                           │
├─────────────────────────────────────────────────────────────┤
│ - mu: RWMutex                                              │
│ - Train: *Train                                            │
│ - WaitQueue: []*WaitOrder                                  │
│ - Orders: map[string]*WaitOrder                            │
│ - OrderCount: int                                          │
├─────────────────────────────────────────────────────────────┤
│ + QueryTicket(): *Train                                    │
│ + BuyTicket(passenger: Passenger): (bool, string)          │
│ + AddToWaitList(req: WaitRequest): *WaitOrder              │
│ + CheckWaitPosition(orderID: string): (*WaitOrder, bool)   │
│ + ProcessRefund()                                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 包含
                            ▼
        ┌───────────────────────────────────┐
        │           Train                    │
        ├───────────────────────────────────┤
        │ + ID: string                      │
        │ + From: string                    │
        │ + To: string                      │
        │ + Total: int                      │
        │ + Sold: int                       │
        │ + Date: string                    │
        └───────────────────────────────────┘

                            │
                            │ 管理
                            ▼
        ┌───────────────────────────────────┐
        │         WaitOrder                  │
        ├───────────────────────────────────┤
        │ + OrderID: string                 │
        │ + Passenger: Passenger            │
        │ + TrainID: string                 │
        │ + Date: string                    │
        │ + CreateTime: time.Time           │
        │ + Position: int                   │
        │ + Status: string                  │
        └───────────────────────────────────┘
                            │
                            │ 包含
                            ▼
        ┌───────────────────────────────────┐
        │         Passenger                  │
        ├───────────────────────────────────┤
        │ + ID: string                      │
        │ + Name: string                    │
        └───────────────────────────────────┘
```

### 2.2 类说明

#### TicketSystem（票务系统）
**职责**: 管理车票、候补队列和订单

**属性**:
- `mu`: 读写锁，保证并发安全
- `Train`: 车次信息
- `WaitQueue`: 候补队列（FIFO）
- `Orders`: 订单映射表（订单号 -> 订单）
- `OrderCount`: 订单计数器

**方法**:
- `QueryTicket()`: 查询余票信息
- `BuyTicket()`: 购买车票
- `AddToWaitList()`: 加入候补队列
- `CheckWaitPosition()`: 查询候补位置
- `ProcessRefund()`: 处理退票并触发候补兑现

#### Train（车次）
**职责**: 存储车次基本信息

**属性**:
- `ID`: 车次号（如"G1001"）
- `From`: 出发地
- `To`: 目的地
- `Total`: 总票数
- `Sold`: 已售票数
- `Date`: 乘车日期

#### WaitOrder（候补订单）
**职责**: 存储候补订单信息

**属性**:
- `OrderID`: 订单号
- `Passenger`: 乘客信息
- `TrainID`: 车次号
- `Date`: 乘车日期
- `CreateTime`: 创建时间
- `Position`: 排队位置
- `Status`: 订单状态（waiting/success/failed）

#### Passenger（乘客）
**职责**: 存储乘客基本信息

**属性**:
- `ID`: 乘客身份证号
- `Name`: 乘客姓名

### 2.3 数据关系

```
TicketSystem (1) ──────> (1) Train
      │
      │
      ├──────> (0..*) WaitOrder
      │
      └──────> (0..*) Orders [map]

WaitOrder (1) ──────> (1) Passenger
```

## 三、活动图设计

### 3.1 购票流程活动图

```
        开始
         │
         ▼
    ┌─────────┐
    │ 查询余票 │
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │ 有余票？ │
    └────┬────┘
         │
    ┌────┴────┐
    │         │
   是         否
    │         │
    ▼         ▼
┌────────┐ ┌──────────┐
│ 直接购票│ │提示无票   │
└───┬────┘ └────┬─────┘
    │           │
    │           ▼
    │      ┌──────────┐
    │      │选择候补？ │
    │      └────┬─────┘
    │           │
    │      ┌────┴────┐
    │      │         │
    │     是         否
    │      │         │
    │      ▼         ▼
    │  ┌────────┐ ┌──────┐
    │  │加入候补│ │ 结束 │
    │  └───┬────┘ └──────┘
    │      │
    └──────┴──────┐
                  │
                  ▼
              ┌────────┐
              │购票成功 │
              └───┬────┘
                  │
                  ▼
                 结束
```

### 3.2 候补功能活动图

```
                    开始
                     │
                     ▼
              ┌─────────────┐
              │ 输入乘客信息 │
              └──────┬──────┘
                     │
                     ▼
              ┌─────────────┐
              │ 验证信息完整 │
              └──────┬──────┘
                     │
                ┌────┴────┐
                │         │
              有效       无效
                │         │
                │         ▼
                │    ┌─────────┐
                │    │提示错误  │
                │    └────┬────┘
                │         │
                │         ▼
                │       结束
                │
                ▼
         ┌─────────────┐
         │ 确认候补订单 │
         │ (模拟支付)   │
         └──────┬──────┘
                │
                ▼
         ┌─────────────┐
         │ 生成订单号   │
         └──────┬──────┘
                │
                ▼
         ┌─────────────┐
         │ 加入候补队列 │
         └──────┬──────┘
                │
                ▼
         ┌─────────────┐
         │ 分配排队位置 │
         └──────┬──────┘
                │
                ▼
         ┌─────────────┐
         │ 显示订单信息 │
         └──────┬──────┘
                │
                ▼
         ┌─────────────┐
         │ 等待兑现...  │
         └──────┬──────┘
                │
                ▼
               结束
```

### 3.3 退票与候补兑现活动图

```
                    开始
                     │
                     ▼
              ┌─────────────┐
              │ 确认退票操作 │
              └──────┬──────┘
                     │
                     ▼
              ┌─────────────┐
              │ 减少已售票数 │
              └──────┬──────┘
                     │
                     ▼
              ┌─────────────┐
              │候补队列为空？│
              └──────┬──────┘
                     │
                ┌────┴────┐
                │         │
               是         否
                │         │
                │         ▼
                │  ┌─────────────┐
                │  │ 获取队首订单 │
                │  └──────┬──────┘
                │         │
                │         ▼
                │  ┌─────────────┐
                │  │ 自动购票     │
                │  └──────┬──────┘
                │         │
                │         ▼
                │  ┌─────────────┐
                │  │更新订单状态  │
                │  │(success)    │
                │  └──────┬──────┘
                │         │
                │         ▼
                │  ┌─────────────┐
                │  │从队列中移除  │
                │  └──────┬──────┘
                │         │
                │         ▼
                │  ┌─────────────┐
                │  │更新其他订单  │
                │  │的排队位置    │
                │  └──────┬──────┘
                │         │
                │         ▼
                │  ┌─────────────┐
                │  │ 通知用户     │
                │  └──────┬──────┘
                │         │
                └─────────┴──────┐
                                 │
                                 ▼
                          ┌─────────────┐
                          │ 退票完成     │
                          └──────┬──────┘
                                 │
                                 ▼
                                结束
```

### 3.4 查询候补状态活动图

```
        开始
         │
         ▼
    ┌─────────┐
    │输入订单号│
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │查询订单  │
    └────┬────┘
         │
    ┌────┴────┐
    │         │
  存在       不存在
    │         │
    ▼         ▼
┌────────┐ ┌──────────┐
│获取订单 │ │提示不存在 │
│信息     │ └────┬─────┘
└───┬────┘      │
    │           │
    ▼           ▼
┌────────┐    结束
│更新排队 │
│位置     │
└───┬────┘
    │
    ▼
┌────────┐
│显示订单 │
│状态     │
└───┬────┘
    │
    ▼
┌────────┐
│显示排队 │
│位置     │
└───┬────┘
    │
    ▼
   结束
```

## 四、并发控制设计

### 4.1 锁机制

系统使用 `sync.RWMutex` 实现读写锁：

```
读操作（允许并发）:
- QueryTicket()
- CheckWaitPosition()

写操作（互斥执行）:
- BuyTicket()
- AddToWaitList()
- ProcessRefund()
```

### 4.2 并发场景

#### 场景1: 多客户端同时购票
```
客户端A ──┐
         ├──> [锁] BuyTicket() [解锁]
客户端B ──┤
         └──> 等待锁释放 -> [锁] BuyTicket() [解锁]
客户端C ──┘
```

#### 场景2: 购票与查询并发
```
客户端A ──> [写锁] BuyTicket() [解锁]
                    │
客户端B ──> [读锁] QueryTicket() [解锁]
            (等待写锁释放)
```

#### 场景3: 退票触发候补兑现
```
客户端A ──> [写锁] ProcessRefund()
              │
              ├──> 减少已售票数
              │
              ├──> 检查候补队列
              │
              ├──> 为队首乘客购票
              │
              ├──> 更新队列
              │
              └──> [解锁]
```

## 五、状态转换图

### 5.1 候补订单状态转换

```
    [创建订单]
        │
        ▼
   ┌─────────┐
   │ waiting │ ◄──┐
   │ (等待中) │    │
   └────┬────┘    │
        │         │
   ┌────┴────┐    │
   │         │    │
  有退票    超时   │
   │         │    │
   ▼         ▼    │
┌────────┐ ┌────────┐
│success │ │ failed │
│(已兑现)│ │(已失败)│
└────────┘ └────────┘
```

### 5.2 票务系统状态

```
初始状态: Sold = 0, WaitQueue = []

购票: Sold++

退票: Sold--
      ↓
   有候补？
      ↓
     是: WaitQueue[0].Status = "success"
         WaitQueue = WaitQueue[1:]
         Sold++
```

## 六、消息协议设计

### 6.1 消息格式

```json
{
    "type": "消息类型",
    "data": "JSON数据",
    "success": true/false,
    "message": "提示信息"
}
```

### 6.2 消息类型

| 类型 | 说明 | 方向 |
|------|------|------|
| query_ticket | 查询余票 | 客户端 → 服务器 |
| buy_ticket | 购买车票 | 客户端 → 服务器 |
| wait_list | 加入候补 | 客户端 → 服务器 |
| check_wait | 查询候补 | 客户端 → 服务器 |
| refund | 退票 | 客户端 → 服务器 |
| response | 响应 | 服务器 → 客户端 |

## 七、前端架构设计

### 7.1 Vue组件结构

```
App (根组件)
├── Header (头部)
│   └── ConnectionStatus (连接状态)
├── TrainInfo (车次信息)
├── Operations (操作面板)
│   ├── PassengerForm (乘客表单)
│   ├── ActionButtons (操作按钮)
│   └── OrderQuery (订单查询)
├── WaitQueue (候补队列)
│   └── OrderItem (订单项)
├── Messages (系统消息)
│   └── MessageItem (消息项)
└── ConfirmDialog (确认对话框)
```

### 7.2 数据流

```
用户操作
   ↓
Vue方法
   ↓
发送消息 (sendMessage)
   ↓
[模拟] 服务器处理
   ↓
接收响应
   ↓
更新Vue数据
   ↓
视图更新
```

## 八、安全性设计

### 8.1 并发安全
- 使用读写锁保护共享数据
- 原子操作保证数据一致性

### 8.2 数据验证
- 乘客信息完整性检查
- 订单号有效性验证
- 操作权限验证

### 8.3 错误处理
- 网络异常处理
- 数据解析错误处理
- 业务逻辑错误提示

## 九、性能优化

### 9.1 后端优化
- 读写锁分离，提高并发读性能
- 候补队列使用切片，O(1)访问
- 订单映射表，O(1)查询

### 9.2 前端优化
- Vue响应式数据，按需更新
- 消息列表限制数量（20条）
- CSS动画使用transform，GPU加速

## 十、扩展性设计

### 10.1 可扩展点

1. **多车次支持**: 将Train改为map[string]*Train
2. **座位类型**: 添加SeatType字段（一等座、二等座）
3. **中途站点**: 支持区间购票
4. **支付系统**: 集成真实支付接口
5. **通知系统**: 添加邮件/短信通知
6. **数据持久化**: 集成数据库

### 10.2 架构演进

```
当前: 单机 C/S 架构
  ↓
优化: 微服务架构
  ├── 票务服务
  ├── 候补服务
  ├── 订单服务
  └── 通知服务
  ↓
进阶: 分布式架构
  ├── 负载均衡
  ├── 分布式缓存
  ├── 消息队列
  └── 数据库集群
```

## 十一、总结

本系统通过合理的类模型设计和清晰的活动流程，实现了完整的火车票候补功能。系统具有良好的并发安全性、可扩展性和用户体验，为实际的票务系统提供了参考实现。
