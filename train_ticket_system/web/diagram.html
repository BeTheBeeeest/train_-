<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>候补功能设计图 - 火车票候补系统</title>
    <link rel="stylesheet" href="diagram.css">
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入Mermaid.js用于绘制图表 - 使用更稳定的CDN -->
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- 页面头部 -->
        <header class="header">
            <div class="container">
                <h1><i class="fas fa-diagram-project"></i> 候补功能设计图</h1>
                <nav class="nav-buttons">
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-home"></i> 返回主页
                    </a>
                </nav>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="container">
            <!-- 导航菜单 -->
            <section class="card nav-menu">
                <h2><i class="fas fa-list"></i> 快速导航</h2>
                <div class="nav-links">
                    <a href="#class-diagram" class="nav-link">
                        <i class="fas fa-cube"></i> 类模型图
                    </a>
                    <a href="#activity-purchase" class="nav-link">
                        <i class="fas fa-shopping-cart"></i> 购票流程活动图
                    </a>
                    <a href="#activity-waitlist" class="nav-link">
                        <i class="fas fa-list-ol"></i> 候补流程活动图
                    </a>
                    <a href="#activity-refund" class="nav-link">
                        <i class="fas fa-undo"></i> 退票与兑现活动图
                    </a>
                    <a href="#activity-query" class="nav-link">
                        <i class="fas fa-search"></i> 查询候补活动图
                    </a>
                    <a href="#state-diagram" class="nav-link">
                        <i class="fas fa-exchange-alt"></i> 状态转换图
                    </a>
                </div>
            </section>

            <!-- 类模型图 -->
            <section class="card diagram-section" id="class-diagram">
                <h2><i class="fas fa-cube"></i> 类模型图 - 候补功能数据关系</h2>
                <div class="diagram-description">
                    <p>本图展示了火车票候补系统的核心类及其关系，包括票务系统、车次、候补订单和乘客信息。</p>
                </div>
                <div class="diagram-container">
                    <div class="mermaid">
classDiagram
    class TicketSystem {
        -RWMutex mu
        -Train train
        -WaitOrder[] waitQueue
        -map~string,WaitOrder~ orders
        -int orderCount
        +QueryTicket() Train
        +BuyTicket(Passenger) bool
        +AddToWaitList(WaitRequest) WaitOrder
        +CheckWaitPosition(string) WaitOrder
        +ProcessRefund() bool
    }
    
    class Train {
        +string id
        +string from
        +string to
        +int total
        +int sold
        +string date
        +GetRemainingTickets() int
    }
    
    class WaitOrder {
        +string orderID
        +Passenger passenger
        +string trainID
        +string date
        +time createTime
        +int position
        +string status
        +UpdateStatus(string)
        +UpdatePosition(int)
    }
    
    class Passenger {
        +string id
        +string name
        +ValidateInfo() bool
    }
    
    class WaitRequest {
        +Passenger passenger
        +string trainID
        +string date
    }
    
    TicketSystem "1" *-- "1" Train : 管理
    TicketSystem "1" *-- "0..*" WaitOrder : 维护候补队列
    TicketSystem "1" o-- "0..*" WaitOrder : 存储订单映射
    WaitOrder "1" *-- "1" Passenger : 包含
    WaitRequest "1" *-- "1" Passenger : 包含
    
    note for TicketSystem "核心票务系统\n使用读写锁保证并发安全\n管理车次信息和候补队列"
    note for WaitOrder "候补订单\n状态: waiting/success/failed\n按创建时间排队"
                    </div>
                </div>
                <div class="diagram-legend">
                    <h3>类关系说明：</h3>
                    <ul>
                        <li><strong>TicketSystem（票务系统）</strong>：系统核心类，管理所有票务和候补操作</li>
                        <li><strong>Train（车次）</strong>：存储车次基本信息，包括余票数量</li>
                        <li><strong>WaitOrder（候补订单）</strong>：候补队列中的订单，包含状态和排队位置</li>
                        <li><strong>Passenger（乘客）</strong>：乘客基本信息</li>
                        <li><strong>WaitRequest（候补请求）</strong>：用户提交候补时的请求数据</li>
                    </ul>
                </div>
            </section>

            <!-- 购票流程活动图 -->
            <section class="card diagram-section" id="activity-purchase">
                <h2><i class="fas fa-shopping-cart"></i> 购票流程活动图</h2>
                <div class="diagram-description">
                    <p>展示用户从查询余票到完成购票或加入候补的完整流程。</p>
                </div>
                <div class="diagram-container">
                    <div class="mermaid">
flowchart TD
    Start([开始]) --> QueryTicket[查询余票]
    QueryTicket --> HasTicket{是否有余票?}
    
    HasTicket -->|有余票| DirectBuy[输入乘客信息]
    DirectBuy --> ConfirmBuy[确认购票]
    ConfirmBuy --> BuySuccess[购票成功]
    BuySuccess --> End1([结束])
    
    HasTicket -->|无余票| NoTicket[提示无票]
    NoTicket --> WantWait{是否选择候补?}
    
    WantWait -->|是| InputInfo[输入乘客信息]
    InputInfo --> ValidateInfo{验证信息}
    ValidateInfo -->|有效| ConfirmWait[确认候补订单]
    ValidateInfo -->|无效| ErrorMsg[显示错误信息]
    ErrorMsg --> InputInfo
    
    ConfirmWait --> AddQueue[加入候补队列]
    AddQueue --> ShowOrder[显示订单信息]
    ShowOrder --> End2([结束])
    
    WantWait -->|否| End3([结束])
    
    style Start fill:#e1f5e1
    style End1 fill:#ffe1e1
    style End2 fill:#ffe1e1
    style End3 fill:#ffe1e1
    style BuySuccess fill:#c8e6c9
    style ShowOrder fill:#c8e6c9
    style HasTicket fill:#fff3cd
    style WantWait fill:#fff3cd
    style ValidateInfo fill:#fff3cd
                    </div>
                </div>
                <div class="diagram-legend">
                    <h3>流程说明：</h3>
                    <ul>
                        <li><strong>查询阶段</strong>：用户首先查询车次余票信息</li>
                        <li><strong>有票情况</strong>：直接进入购票流程，输入信息后完成购买</li>
                        <li><strong>无票情况</strong>：提示无票，用户可选择加入候补队列</li>
                        <li><strong>候补流程</strong>：验证信息 → 确认订单 → 加入队列 → 等待兑现</li>
                    </ul>
                </div>
            </section>

            <!-- 候补流程活动图 -->
            <section class="card diagram-section" id="activity-waitlist">
                <h2><i class="fas fa-list-ol"></i> 候补功能活动图</h2>
                <div class="diagram-description">
                    <p>详细展示候补订单从创建到进入队列的完整过程。</p>
                </div>
                <div class="diagram-container">
                    <div class="mermaid">
flowchart TD
    Start([开始候补流程]) --> InputPass[输入乘客信息]
    InputPass --> ValidateInfo{验证信息完整性}
    
    ValidateInfo -->|信息不完整| ShowError[提示错误信息]
    ShowError --> InputPass
    
    ValidateInfo -->|信息完整| ConfirmDialog[弹出确认对话框]
    ConfirmDialog --> PayConfirm{用户确认支付?}
    
    PayConfirm -->|取消| Cancel([取消候补])
    
    PayConfirm -->|确认| GenerateOrder[生成订单号]
    GenerateOrder --> CreateOrder[创建候补订单对象]
    CreateOrder --> AddQueue[加入候补队列]
    AddQueue --> CalcPosition[计算排队位置]
    CalcPosition --> SaveOrder[保存到订单映射表]
    SaveOrder --> UpdateUI[更新界面显示]
    UpdateUI --> ShowSuccess[显示候补成功信息]
    ShowSuccess --> DisplayOrder[显示订单详情]
    DisplayOrder --> Waiting[进入等待状态...]
    Waiting --> End([结束])
    
    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style Cancel fill:#ffe1e1
    style ShowSuccess fill:#c8e6c9
    style DisplayOrder fill:#c8e6c9
    style ValidateInfo fill:#fff3cd
    style PayConfirm fill:#fff3cd
    style Waiting fill:#e3f2fd
                    </div>
                </div>
                <div class="diagram-legend">
                    <h3>候补流程关键步骤：</h3>
                    <ul>
                        <li><strong>信息验证</strong>：检查乘客ID和姓名是否完整</li>
                        <li><strong>支付确认</strong>：模拟支付确认过程</li>
                        <li><strong>生成订单</strong>：分配唯一的订单号（W + 时间戳）</li>
                        <li><strong>加入队列</strong>：按时间顺序加入FIFO队列</li>
                        <li><strong>分配位置</strong>：自动计算当前排队位置</li>
                        <li><strong>等待兑现</strong>：订单进入等待状态，可随时查询</li>
                    </ul>
                </div>
            </section>

            <!-- 退票与候补兑现活动图 -->
            <section class="card diagram-section" id="activity-refund">
                <h2><i class="fas fa-undo"></i> 退票与候补兑现活动图</h2>
                <div class="diagram-description">
                    <p>展示退票操作如何触发候补队列的自动兑现机制。</p>
                </div>
                <div class="diagram-container">
                    <div class="mermaid">
flowchart TD
    Start([开始退票]) --> ConfirmRefund[确认退票操作]
    ConfirmRefund --> DecreaseSold[减少已售票数]
    DecreaseSold --> CheckQueue{候补队列是否为空?}
    
    CheckQueue -->|队列为空| RefundOnly[仅完成退票]
    RefundOnly --> UpdateDisplay1[更新余票显示]
    UpdateDisplay1 --> End1([退票完成])
    
    CheckQueue -->|队列不为空| GetFirst[获取队首订单]
    GetFirst --> AutoBuy[自动为该乘客购票]
    AutoBuy --> IncreaseSold[增加已售票数]
    IncreaseSold --> UpdateStatus[更新订单状态为success]
    UpdateStatus --> RemoveFromQueue[从候补队列移除]
    RemoveFromQueue --> UpdatePositions[更新其他订单排队位置]
    UpdatePositions --> NotifyUser[通知用户候补成功]
    NotifyUser --> UpdateDisplay2[更新界面显示]
    UpdateDisplay2 --> End2([退票并兑现完成])
    
    style Start fill:#e1f5e1
    style End1 fill:#ffe1e1
    style End2 fill:#ffe1e1
    style AutoBuy fill:#c8e6c9
    style NotifyUser fill:#c8e6c9
    style CheckQueue fill:#fff3cd
    style UpdateStatus fill:#bbdefb
                    </div>
                </div>
                <div class="diagram-legend">
                    <h3>退票兑现机制：</h3>
                    <ul>
                        <li><strong>自动触发</strong>：退票操作自动检查候补队列</li>
                        <li><strong>FIFO原则</strong>：优先为队首（最早加入）的乘客购票</li>
                        <li><strong>状态更新</strong>：成功兑现的订单状态变为"success"</li>
                        <li><strong>位置更新</strong>：队列中其他订单位置自动前移</li>
                        <li><strong>实时通知</strong>：通过界面消息通知用户兑现成功</li>
                        <li><strong>原子操作</strong>：整个过程使用写锁保证线程安全</li>
                    </ul>
                </div>
            </section>

            <!-- 查询候补状态活动图 -->
            <section class="card diagram-section" id="activity-query">
                <h2><i class="fas fa-search"></i> 查询候补状态活动图</h2>
                <div class="diagram-description">
                    <p>用户通过订单号查询候补状态和排队位置的流程。</p>
                </div>
                <div class="diagram-container">
                    <div class="mermaid">
flowchart TD
    Start([开始查询]) --> InputOrder[输入订单号]
    InputOrder --> QueryOrder[查询订单信息]
    QueryOrder --> OrderExists{订单是否存在?}
    
    OrderExists -->|不存在| ShowNotFound[显示订单不存在]
    ShowNotFound --> End1([查询结束])
    
    OrderExists -->|存在| GetOrderInfo[获取订单信息]
    GetOrderInfo --> CheckStatus{订单状态}
    
    CheckStatus -->|waiting| CalcPosition[计算当前排队位置]
    CalcPosition --> ShowWaiting[显示等待状态和位置]
    ShowWaiting --> End2([查询结束])
    
    CheckStatus -->|success| ShowSuccess[显示已兑现信息]
    ShowSuccess --> End3([查询结束])
    
    CheckStatus -->|failed| ShowFailed[显示失败信息]
    ShowFailed --> End4([查询结束])
    
    style Start fill:#e1f5e1
    style End1 fill:#ffe1e1
    style End2 fill:#ffe1e1
    style End3 fill:#ffe1e1
    style End4 fill:#ffe1e1
    style ShowSuccess fill:#c8e6c9
    style ShowWaiting fill:#fff9c4
    style ShowFailed fill:#ffcdd2
    style OrderExists fill:#fff3cd
    style CheckStatus fill:#fff3cd
                    </div>
                </div>
                <div class="diagram-legend">
                    <h3>查询功能说明：</h3>
                    <ul>
                        <li><strong>订单查询</strong>：通过订单号快速检索订单信息</li>
                        <li><strong>状态显示</strong>：
                            <ul>
                                <li><code>waiting</code>：显示当前排队位置</li>
                                <li><code>success</code>：显示已成功兑现</li>
                                <li><code>failed</code>：显示兑现失败</li>
                            </ul>
                        </li>
                        <li><strong>实时位置</strong>：等待中的订单实时计算队列位置</li>
                        <li><strong>用户体验</strong>：清晰的状态反馈和位置信息</li>
                    </ul>
                </div>
            </section>

            <!-- 状态转换图 -->
            <section class="card diagram-section" id="state-diagram">
                <h2><i class="fas fa-exchange-alt"></i> 候补订单状态转换图</h2>
                <div class="diagram-description">
                    <p>展示候补订单在不同阶段的状态变化。</p>
                </div>
                <div class="diagram-container">
                    <div class="mermaid">
stateDiagram-v2
    [*] --> 创建订单
    创建订单 --> waiting: 加入候补队列
    
    waiting --> success: 有退票，自动购票成功
    waiting --> failed: 超时或其他原因失败
    waiting --> waiting: 继续等待（位置可能前移）
    
    success --> [*]
    failed --> [*]
    
    note right of waiting
        等待中状态
        - 在候补队列中
        - 可查询排队位置
        - 位置会随着兑现而前移
    end note
    
    note right of success
        已兑现状态
        - 自动购票成功
        - 从队列中移除
        - 不可再变更
    end note
    
    note right of failed
        失败状态
        - 兑现失败
        - 可能原因：超时等
        - 不可再变更
    end note
                    </div>
                </div>
                <div class="diagram-legend">
                    <h3>状态说明：</h3>
                    <ul>
                        <li><strong>waiting（等待中）</strong>：订单在候补队列中，等待有退票时自动兑现</li>
                        <li><strong>success（已兑现）</strong>：有退票时系统自动购票成功，订单完成</li>
                        <li><strong>failed（已失败）</strong>：因超时或其他原因导致候补失败</li>
                    </ul>
                    <h3>状态特点：</h3>
                    <ul>
                        <li>订单创建后立即进入<code>waiting</code>状态</li>
                        <li><code>waiting</code>状态可以持续较长时间，用户可随时查询位置</li>
                        <li><code>success</code>和<code>failed</code>是终态，不可变更</li>
                        <li>当前系统主要实现了自动兑现机制，超时失败功能可扩展</li>
                    </ul>
                </div>
            </section>

            <!-- 技术说明 -->
            <section class="card tech-info">
                <h2><i class="fas fa-info-circle"></i> 技术实现说明</h2>
                <div class="tech-details">
                    <div class="tech-item">
                        <h3><i class="fas fa-lock"></i> 并发控制</h3>
                        <p>使用Go语言的<code>sync.RWMutex</code>读写锁实现并发安全：</p>
                        <ul>
                            <li><strong>读操作</strong>：QueryTicket、CheckWaitPosition（允许并发）</li>
                            <li><strong>写操作</strong>：BuyTicket、AddToWaitList、ProcessRefund（互斥执行）</li>
                        </ul>
                    </div>
                    
                    <div class="tech-item">
                        <h3><i class="fas fa-database"></i> 数据结构</h3>
                        <ul>
                            <li><strong>候补队列</strong>：使用切片（slice）实现FIFO队列，O(1)访问</li>
                            <li><strong>订单映射</strong>：使用map存储订单号到订单的映射，O(1)查询</li>
                            <li><strong>排队位置</strong>：动态计算，随着队列变化自动更新</li>
                        </ul>
                    </div>
                    
                    <div class="tech-item">
                        <h3><i class="fas fa-network-wired"></i> 通信协议</h3>
                        <p>客户端与服务器采用TCP协议通信，消息格式为JSON：</p>
                        <ul>
                            <li><strong>query_ticket</strong>：查询余票</li>
                            <li><strong>buy_ticket</strong>：购买车票</li>
                            <li><strong>wait_list</strong>：加入候补</li>
                            <li><strong>check_wait</strong>：查询候补</li>
                            <li><strong>refund</strong>：退票</li>
                        </ul>
                    </div>
                    
                    <div class="tech-item">
                        <h3><i class="fas fa-chart-line"></i> 性能优化</h3>
                        <ul>
                            <li><strong>读写分离</strong>：查询操作使用读锁，提高并发性能</li>
                            <li><strong>原子操作</strong>：退票和兑现在同一个写锁内完成，保证一致性</li>
                            <li><strong>内存存储</strong>：当前使用内存存储，响应快速，可扩展到数据库</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- 返回顶部按钮 -->
            <button class="back-to-top" id="backToTop" title="返回顶部">
                <i class="fas fa-arrow-up"></i>
            </button>
        </main>

        <!-- 页面底部 -->
        <footer class="footer">
            <div class="container">
                <p>&copy; 2024 火车票候补系统 | 设计文档</p>
                <p>基于Go语言开发，采用Vue 3和Mermaid.js可视化</p>
            </div>
        </footer>
    </div>

    <script>
        // 等待 DOM 完全加载后再初始化 Mermaid
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Mermaid配置
            mermaid.initialize({ 
                startOnLoad: true,
                theme: 'default',
                securityLevel: 'loose',
                themeVariables: {
                    // 类图配置 - 提高对比度
                    primaryColor: '#E3F2FD',        // 浅蓝色背景
                    primaryTextColor: '#000000',    // 黑色文字
                    primaryBorderColor: '#1976D2',  // 深蓝色边框
                    
                    // 类图特定颜色
                    classText: '#000000',           // 类名文字：黑色
                    
                    // 其他元素
                    lineColor: '#424242',           // 连线颜色：深灰
                    secondaryColor: '#FFF9C4',      // 次要颜色：浅黄
                    tertiaryColor: '#F8BBD0',       // 第三颜色：浅粉
                    
                    // 流程图配置
                    nodeBorder: '#1976D2',
                    mainBkg: '#E3F2FD',
                    textColor: '#000000',
                    
                    // 注释框
                    noteBkgColor: '#FFF59D',        // 注释背景：亮黄
                    noteTextColor: '#000000',        // 注释文字：黑色
                    noteBorderColor: '#F57C00'       // 注释边框：橙色
                },
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                },
                class: {
                    useMaxWidth: true
                }
            });
            
            // 手动触发渲染（兼容性更好）
            try {
                mermaid.contentLoaded();
            } catch(e) {
                console.log('Mermaid rendering:', e);
            }
        });

        // 平滑滚动到锚点
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // 返回顶部按钮功能
        const backToTopButton = document.getElementById('backToTop');
        
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopButton.classList.add('visible');
            } else {
                backToTopButton.classList.remove('visible');
            }
        });

        backToTopButton.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
