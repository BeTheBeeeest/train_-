# 候补功能设计图表说明

## 📊 概述

本文档介绍火车票候补系统的设计图表，包括类模型图和活动图，帮助理解系统的数据结构和业务流程。

## 🔧 故障排除

### ❓ 图表显示为代码文本？

如果你看到的是代码和数字，而不是漂亮的图表，可能是以下原因：

#### 原因1：Mermaid.js 未加载
**解决方案**：
1. 检查网络连接
2. 强制刷新页面（Ctrl+F5 或 Cmd+Shift+R）
3. 打开浏览器控制台（F12）查看是否有错误

#### 原因2：CDN被墙或网络问题
**解决方案**：
1. 使用VPN或代理
2. 等待几分钟后重试
3. 使用测试页面 `diagram_test.html` 验证

#### 原因3：浏览器不兼容
**解决方案**：
1. 使用Chrome、Edge或Firefox最新版本
2. 更新浏览器到最新版本
3. 禁用可能冲突的浏览器插件

### 🧪 测试Mermaid是否正常

访问测试页面：
```
打开 web/diagram_test.html
```

这个页面会：
- ✅ 显示Mermaid加载状态
- ✅ 展示简单的测试图表
- ✅ 提供诊断信息

## 🚀 快速访问

### 方式一：通过主页面访问
1. 打开主页面 `index.html`
2. 点击右上角的"设计图表"按钮

### 方式二：直接打开图表页面
1. 双击运行 `start_diagram.bat`
2. 或直接在浏览器中打开 `diagram.html`

## 📈 图表内容

### 1. 类模型图（Class Diagram）

**用途**：展示候补功能的数据关系和类结构

**核心类**：
- **TicketSystem**：票务系统核心类，管理所有操作
- **Train**：车次信息类
- **WaitOrder**：候补订单类
- **Passenger**：乘客信息类
- **WaitRequest**：候补请求类

**关系说明**：
- TicketSystem 包含一个 Train（1对1关系）
- TicketSystem 维护多个 WaitOrder（1对多关系）
- WaitOrder 包含一个 Passenger（1对1关系）

### 2. 购票流程活动图

**用途**：展示从查询余票到完成购票或加入候补的完整流程

**关键步骤**：
1. 查询余票
2. 判断是否有票
3. 有票 → 直接购票
4. 无票 → 选择是否候补
5. 候补 → 加入队列

### 3. 候补功能活动图

**用途**：详细展示候补订单的创建过程

**关键步骤**：
1. 输入乘客信息
2. 验证信息完整性
3. 确认支付（模拟）
4. 生成订单号
5. 加入候补队列
6. 分配排队位置
7. 显示订单信息

### 4. 退票与候补兑现活动图

**用途**：展示退票如何触发候补自动兑现

**关键机制**：
- 退票后自动检查候补队列
- 如队列不为空，为队首乘客自动购票
- 更新订单状态为"已兑现"
- 更新其他订单的排队位置
- 通知用户兑现成功

### 5. 查询候补状态活动图

**用途**：展示用户查询订单状态的流程

**状态类型**：
- `waiting`：等待中（显示排队位置）
- `success`：已兑现
- `failed`：已失败

### 6. 状态转换图

**用途**：展示候补订单在不同阶段的状态变化

**状态流转**：
```
创建订单 → waiting（等待中）
waiting → success（有退票，自动兑现）
waiting → failed（超时失败）
```

## 🎨 技术实现

### 图表库
使用 **Mermaid.js** 生成动态图表：
- 类图（classDiagram）
- 流程图（flowchart）
- 状态图（stateDiagram）

### 样式特点
- 响应式设计，支持移动端和桌面端
- 清晰的颜色区分（绿色=成功，黄色=判断，红色=结束）
- 平滑滚动导航
- 返回顶部按钮

## 📝 使用技巧

### 1. 快速导航
点击页面顶部的快速导航菜单，可直接跳转到对应图表

### 2. 查看详细说明
每个图表下方都有详细的图例说明和关键步骤解释

### 3. 技术实现说明
页面底部有技术实现的详细说明，包括：
- 并发控制机制
- 数据结构设计
- 通信协议
- 性能优化

### 4. 返回主页
点击页面右上角的"返回主页"按钮可返回购票系统主界面

## 🔧 技术说明

### 并发安全
- 使用 `sync.RWMutex` 读写锁
- 读操作允许并发
- 写操作互斥执行

### 数据结构
- 候补队列：FIFO（先进先出）
- 订单映射：map[string]*WaitOrder
- 时间复杂度：O(1)查询

### 自动兑现机制
- 退票时自动触发
- 按队列顺序兑现
- 原子操作保证一致性

## 📖 相关文档

- `DESIGN_DOCUMENT.md`：详细设计文档（文本版）
- `README.md`：项目说明文档
- `界面说明.md`：前端界面使用说明
- `并发测试说明.md`：并发测试指南

## ❓ 常见问题

### Q1: 图表显示不出来？
A: 请确保网络连接正常，Mermaid.js需要从CDN加载。

### Q2: 如何打印图表？
A: 使用浏览器的打印功能（Ctrl+P），页面已优化打印样式。

### Q3: 手机上能查看吗？
A: 可以，图表页面采用响应式设计，支持移动设备访问。

### Q4: 图表能否导出？
A: 可以在浏览器中右键保存图表为图片，或使用截图工具。

## 🎯 设计原则

1. **清晰性**：图表结构清晰，易于理解
2. **完整性**：覆盖所有关键业务流程
3. **准确性**：图表与实际代码实现一致
4. **美观性**：配色合理，视觉效果好
5. **实用性**：方便开发和维护人员查阅

## 📞 反馈建议

如果您对图表有任何建议或发现错误，欢迎反馈！

---

**最后更新时间**：2024年

**版本**：v1.0
