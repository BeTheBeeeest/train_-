# 火车票候补系统

## 项目概述

这是一个基于Go语言开发的火车票候补系统，采用C/S架构，支持多客户端并发操作。系统实现了完整的候补购票功能，包括查询余票、购买车票、加入候补队列、查询候补位置和退票等功能。

**现已新增Web前端界面**，基于Vue 3开发，提供直观美观的用户交互体验！

## 系统特性

- **多客户端并发支持**: 支持多个客户端同时连接和操作
- **候补队列管理**: 自动管理候补队列，按先来先服务原则分配票源
- **实时状态更新**: 退票后自动为候补队列第一位乘客购票
- **线程安全**: 使用读写锁确保并发安全
- **简单易用**: 命令行界面，操作直观

## 系统架构

### 核心组件

1. **服务器端 (server/main.go)**
   - `TicketSystem`: 票务系统核心逻辑
   - `TicketServer`: 网络服务器，处理客户端连接
   - 候补队列管理和自动分配机制

2. **客户端 (client/main.go)**
   - `TicketClient`: 客户端连接和操作
   - 用户交互界面
   - 网络通信封装

3. **Web前端 (web/)**
   - 基于Vue 3的现代化Web界面
   - 响应式设计，支持移动端和桌面端
   - 实时显示车次信息和候补队列
   - 美观的用户交互体验

### 数据模型

#### 车次信息 (Train)
```go
type Train struct {
    ID    string // 车次号
    From  string // 出发地
    To    string // 目的地
    Total int    // 总票数
    Sold  int    // 已售票数
    Date  string // 日期
}
```

#### 乘客信息 (Passenger)
```go
type Passenger struct {
    ID   string // 乘客ID
    Name string // 乘客姓名
}
```

#### 候补订单 (WaitOrder)
```go
type WaitOrder struct {
    OrderID    string    // 订单号
    Passenger  Passenger // 乘客信息
    TrainID    string    // 车次号
    Date       string    // 日期
    CreateTime time.Time // 创建时间
    Position   int       // 排队位置
    Status     string    // 状态 (waiting/success/failed)
}
```

## 候补功能流程

### 1. 查询与选择
- 用户查询车票信息
- 系统显示余票数量
- 如无余票，提示可选择候补

### 2. 添加候补需求
- 用户输入乘客信息
- 系统生成候补订单
- 加入候补队列并分配排队位置

### 3. 支付确认
- 系统模拟支付确认过程
- 候补订单正式生效

### 4. 等待兑现
- 订单进入候补队列
- 用户可查询排队位置和状态

### 5. 自动兑现
- 有退票时，系统自动为队列第一位乘客购票
- 更新队列中其他乘客的排队位置
- 成功购票的订单状态更新为"success"

### 6. 兑现失败处理
- 系统支持查询订单状态
- 可扩展添加超时自动退款机制

## 安装和运行

### 环境要求
- Go 1.21 或更高版本
- 现代浏览器（Chrome、Firefox、Safari、Edge）

### 运行步骤

#### 方式一：使用命令行客户端

1. **启动服务器**
```bash
cd server
go run main.go
```
服务器将在端口8080启动

2. **启动客户端**
```bash
cd client
go run main.go
```

3. **多客户端测试**
可以同时运行多个客户端实例来测试并发功能

#### 方式二：使用Web前端（推荐）

1. **启动服务器**
```bash
# 双击运行
start_server.bat

# 或使用命令行
cd server
go run main.go
```

2. **打开Web界面**
```bash
# 双击运行
cd web
start_web.bat

# 或直接在浏览器中打开
# web/index.html
```

3. **开始使用**
- 页面会自动连接服务器
- 输入乘客信息进行购票或候补
- 实时查看候补队列状态

## 使用说明

### 客户端操作菜单

1. **查询余票**: 显示当前车次的余票信息
2. **购买车票**: 直接购买车票（如有余票）
3. **加入候补**: 加入候补队列等待购票
4. **查询候补位置**: 根据订单号查询候补状态
5. **退票**: 退票并触发候补队列自动分配

### 操作示例

```
=== 火车票售票系统 ===
1. 查询余票
2. 购买车票  
3. 加入候补
4. 查询候补位置
5. 退票
0. 退出
请选择操作: 1

=== 车次信息 ===
车次: G1001
路线: 武汉 → 北京
日期: 2024-01-01
余票: 100/100
```

## 技术特点

### 并发安全
- 使用`sync.RWMutex`保护共享数据
- 读操作使用读锁，写操作使用写锁
- 确保多客户端并发访问的数据一致性

### 网络通信
- 基于TCP协议的客户端-服务器通信
- JSON格式的消息序列化
- 统一的消息格式和错误处理

### 队列管理
- 先进先出(FIFO)的候补队列
- 自动位置更新机制
- 实时状态跟踪

## 扩展功能建议

1. **数据持久化**: 添加数据库支持，持久化订单和队列信息
2. **超时机制**: 实现候补订单超时自动取消
3. **通知系统**: 添加邮件或短信通知功能
4. **Web界面**: 开发Web版本的用户界面
5. **支付集成**: 集成真实的支付系统
6. **多车次支持**: 扩展支持多个车次和路线

## 项目结构

```
train_ticket_system/
├── server/
│   └── main.go                    # 服务器端代码
├── client/
│   └── main.go                    # 命令行客户端代码
├── web/                           # Web前端目录
│   ├── index.html                 # 主页面
│   ├── app.js                     # Vue应用逻辑
│   ├── style.css                  # 样式文件
│   ├── diagram.html               # 设计图表页面
│   ├── diagram.css                # 图表样式文件
│   ├── start_web.bat              # 启动主页脚本
│   ├── start_diagram.bat          # 启动图表页脚本
│   ├── README.md                  # 前端说明文档
│   ├── FRONTEND_DESIGN.md         # 前端设计文档
│   ├── 用户手册.md                # 完整用户手册（推荐）
│   ├── 文档索引.md                # 文档快速索引
│   ├── 图表说明.md                # 图表使用指南
│   └── 更新日志_图表功能.md       # 图表功能更新日志
├── BACKEND_DESIGN.md              # 后端设计文档
├── DESIGN_DOCUMENT.md             # 完整设计文档（备份）
├── 并发测试说明.md                # 并发测试指南
├── 文档重组说明.md                # 文档重组说明
├── 文档整理记录.md                # 文档整理记录
├── test_concurrent.go             # 并发测试程序
├── go.mod                         # Go模块文件
├── start_server.bat               # 启动服务器脚本
├── start_client.bat               # 启动客户端脚本
└── README.md                      # 项目说明文档
```

## 开发说明

### 后端
本项目完全使用Go语言标准库开发，无外部依赖，便于部署和维护。代码结构清晰，注释详细，适合学习和扩展。

### 前端
- 使用Vue 3 CDN版本，无需构建工具
- 原生JavaScript，易于理解和修改
- 响应式设计，适配各种屏幕尺寸
- 详细的设计文档，包含类模型和活动图

## 设计文档

### 📊 可视化设计图表（新增）
**推荐方式**：通过浏览器查看动态交互式图表
1. 打开主页面后，点击右上角"设计图表"按钮
2. 或双击运行 `web/start_diagram.bat`
3. 或直接打开 `web/diagram.html`

**包含内容**：
- ✨ **类模型图**：展示候补功能的数据关系（使用Mermaid类图）
- ✨ **购票流程活动图**：完整的购票流程
- ✨ **候补功能活动图**：候补订单创建过程
- ✨ **退票与兑现活动图**：自动兑现机制
- ✨ **查询候补活动图**：订单状态查询流程
- ✨ **状态转换图**：订单状态变化流程

### 📄 文本设计文档
详细的候补功能分析和设计请查看：

**后端设计文档**: `BACKEND_DESIGN.md`（主目录）
- 数据模型设计（类图、数据关系）
- 业务流程设计（购票、候补、退票流程图）
- 并发控制设计（读写锁、并发场景）
- 网络通信协议
- 性能优化策略
- 扩展性设计

**前端设计文档**: `web/FRONTEND_DESIGN.md`（web目录）
- Vue组件架构设计
- 数据流设计
- UI/UX设计（色彩、布局、交互）
- 动画效果设计
- 响应式设计
- 性能优化策略

**使用文档**:
- **用户手册**: `web/用户手册.md` - ⭐ 完整的使用指南（推荐新手阅读）
- **图表说明**: `web/图表说明.md` - 可视化图表使用指南
- **并发测试说明**: `并发测试说明.md` - 并发测试指南（主目录）

**其他文档**:
- **文档索引**: `web/文档索引.md` - 快速查找所需文档
- **文档重组说明**: `文档重组说明.md` - 文档拆分说明（主目录）
- **文档整理记录**: `文档整理记录.md` - 文档整理记录（主目录）
- **完整设计文档**: `DESIGN_DOCUMENT.md` - 原始完整版设计文档（主目录）

## 功能演示

### Web界面功能
1. ✅ 车次信息展示（车次号、路线、余票）
2. ✅ 购票功能（输入乘客信息直接购票）
3. ✅ 候补功能（无票时加入候补队列）
4. ✅ 候补确认对话框（模拟支付）
5. ✅ 候补订单管理（查看订单列表和状态）
6. ✅ 排队位置显示（实时显示排队位置）
7. ✅ 订单查询（根据订单号查询状态）
8. ✅ 退票功能（自动触发候补兑现）
9. ✅ 系统消息提示（操作结果实时反馈）
10. ✅ 响应式设计（支持移动端和桌面端）

### 候补功能特点
- **自动化抢票**: 官方自动化的抢票机制
- **有序分配**: 按照先来先服务原则分配票源
- **实时更新**: 退票后自动为候补队列第一位购票
- **状态跟踪**: 实时显示订单状态（等待中/已兑现/已失败）
- **位置查询**: 随时查看自己在队列中的位置

## 许可证

本项目仅供学习和研究使用。
